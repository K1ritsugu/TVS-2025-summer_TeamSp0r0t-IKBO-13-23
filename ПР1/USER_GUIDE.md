# Пользовательское руководство Music Player SPA

# Архитектура системы

Клиентская часть представлена одностраничным приложением на библиотеке **React 18** с использованием **TypeScript 5**. Логика маршрутизации позволяет переходить между страницами без перезагрузки, а менеджмент состояния через **Redux Toolkit** обеспечивает реактивное обновление интерфейса при изменении плейлистов, очереди воспроизведения или авторизации пользователя.

## Взаимодействие с бэкендом  

Для всех HTTP-запросов используется единый экземпляр **RTK Query**, где в качестве базового адреса берётся переменная окружения. Это обеспечивает безопасность и правильную работоспособность кода.

Настроены заголовки по умолчанию и перехватчики, которые автоматически добавляют в каждый запрос JWT-токен из localStorage `token`, который при необходимости передается с бэкенда.

Методы работы с треками, плейлистами и авторизацией вызывают REST-эндпоинты бэкенда:

- **GET /api/tracks** – получение списка треков
- **POST /api/auth/register** и **POST /api/auth/login** – регистрация и вход  
- **GET/POST/DELETE /api/playlists** – управление плейлистами
- **POST /api/upload** – загрузка аудио файлов и обложек
- **POST /api/tracks/:id/favorite** – добавление в избранное

## Сборка и развёртывание

Процесс сборки и запуска приложения автоматизирован с помощью **Vite**. Система использует современные подходы к сборке с поддержкой hot reload для разработки.

Сборка образа базируется на Node.js, который устанавливает зависимости из `package.json` и `pnpm-lock.yaml`. После этого копируется код и происходит TypeScript компиляция.

При старте в development режиме выполняется команда `npm run dev:full`, которая запускает одновременно frontend (Vite dev server) и backend API сервер. Для продакшена используется `npm run build`, создающий оптимизированную сборку в папке `dist/`.

# Общая структура проекта  

Проект организован по принципам **Feature-Sliced Design (FSD)** и модульности. В корне находятся конфигурационные файлы Vite, ESLint и TypeScript, а также папка `src`, внутри которой сосредоточен весь код приложения.

Папка `src` содержит следующие основные директории:

1. **app/** - Конфигурация приложения с роутингом и store setup. Здесь находится `AppRouter` с защищёнными маршрутами и lazy loading компонентов для оптимизации загрузки.

2. **pages/** - Страницы-оболочки, соответствующие маршрутам: dashboard, login, playlists, search, profile, favorites, upload-track. Каждая страница собирает из компонентов законченный интерфейс.

3. **widgets/** - Сложные виджеты как `PlayerWidget` - основной музыкальный плеер с полным функционалом управления воспроизведением, очередью и избранным.

4. **features/** - Бизнес-фичи приложения:
   - `auth/` - Аутентификация с JWT токенами и защищёнными маршрутами
   - `player/` - Управление состоянием плеера (play/pause/next/prev/repeat/shuffle)
   - `theme/` - Переключение между тёмной и светлой темами

5. **entities/** - Бизнес-сущности:
   - `track/` - Модель трека с API для CRUD операций
   - `playlist/` - Управление плейлистами и добавлением треков
   - `user/` - Профили пользователей и настройки

6. **shared/** - Переиспользуемые компоненты, хуки, типы TypeScript и утилиты. Централизованное хранение общих интерфейсов обеспечивает типобезопасность.

Точка входа приложения — `main.tsx`, где происходит инициализация Redux store, Material UI ThemeProvider и React Router.

### Структура главной страницы (Dashboard)

Главная страница (`src/pages/dashboard/`) состоит из следующих блоков:

1. **Sidebar Navigation** - боковая навигация с переходами между разделами: Dashboard, Playlists, Search, Favorites, Profile. Реализована как отдельный компонент с активными состояниями.

2. **Recent Tracks Section** - блок с недавно прослушанными треками. При монтировании компонента через `useEffect` выполняется запрос к API и результаты попадают в Redux store. Треки рендерятся через переиспользуемые `TrackCard` компоненты.

3. **Popular Playlists** - секция с популярными и недавно созданными плейлистами. Каждый плейлист отображается с автоматически сгенерированной обложкой на основе треков внутри.

4. **Statistics Charts** - интерактивные графики статистики прослушиваний с использованием библиотеки **Recharts**. Показывает активность пользователя по дням недели и жанрам.

Такая организация главной страницы разделяет презентационные и контейнерные компоненты, позволяет переиспользовать элементы на других страницах и оптимизирует загрузку данных с сервера.

### Структура страницы авторизации  

Страница авторизации (`src/pages/login/`) объединяет две формы: вход и регистрацию в едином интерфейсе.

Переключатель между режимами реализован через локальный state с **useState**. Компонент использует **React Hook Form** с валидацией через **Yup** схемы для проверки email, пароля и других полей.

При отправке формы вызываются RTK Query мутации `useLoginMutation` или `useRegisterMutation`. В случае успеха JWT-токен сохраняется в localStorage и Redux store, происходит автоматический редирект на dashboard. При ошибке отображается **Material UI Snackbar** с описанием проблемы.

После успешной авторизации пользователь получает доступ к защищённым маршрутам через компонент `ProtectedRoute`, который проверяет наличие валидного токена.

Система также поддерживает автоматическое восстановление сессии при перезагрузке страницы - токен и данные пользователя читаются из localStorage при инициализации приложения.

### Структура музыкального плеера

Основной плеер (`src/widgets/player/`) реализован как фиксированный виджет в нижней части экрана и содержит полный набор элементов управления:

**Базовые контролы:**
- **Play/Pause кнопка** - переключает воспроизведение через `togglePlay` action
- **Previous/Next** - навигация по очереди с помощью `previousTrack`/`nextTrack`
- **Прогресс-бар** - Material UI Slider для перемотки трека с real-time обновлением
- **Громкость** - отдельный слайдер для регулировки volume от 0 до 100%

**Расширенные функции:**
- **Repeat режимы** - отсутствует/повтор трека/повтор плейлиста с визуальными индикаторами
- **Shuffle** - случайное воспроизведение с перемешиванием очереди  
- **Favorite button** - добавление в избранное с мутацией к API
- **Queue dialog** - модальное окно с полным списком очереди и drag&drop для перестановки

Плеер использует HTML5 `<audio>` элемент с ref для прямого управления воспроизведением. Состояние синхронизируется между DOM audio элементом и Redux store через useEffect хуки.

При окончании трека автоматически обрабатываются repeat режимы или переход к следующему треку в зависимости от настроек пользователя.

### Структура страницы плейлистов

Страница плейлистов (`src/pages/playlists/`) представляет собой полноценную систему управления музыкальными коллекциями:

**Список плейлистов** отображается в виде сетки карточек. Каждая карточка содержит:
- Автоматически сгенерированную обложку из первых треков
- Название плейлиста с возможностью inline редактирования  
- Количество треков и общую продолжительность
- Контекстное меню для операций (переименование, удаление, воспроизведение)

**Создание нового плейлиста** происходит через модальное окно с валидацией названия. После создания пользователь может сразу добавлять треки или автоматически перейти к странице добавления треков.

**Детальная страница плейлиста** (`src/pages/playlists/[id]/`) включает:
- Полный список треков с возможностью сортировки
- Drag & drop для изменения порядка треков
- Bulk операции (удаление выбранных, добавление в другие плейлисты)
- Статистика плейлиста (общее время, количество исполнителей)

**Добавление треков** (`src/pages/playlists/add-tracks/`) - отдельная страница с поиском и фильтрацией всех доступных треков. Пользователь может выбирать множественные треки через checkboxes и добавлять их batch операцией.

Вся логика плейлистов использует RTK Query для оптимистичных обновлений UI - изменения отображаются мгновенно, а при ошибке API автоматически откатываются к предыдущему состоянию.

### Структура страницы поиска

Страница поиска (`src/pages/search/`) реализует мгновенный поиск с debouncing для оптимизации запросов к серверу:

**Поисковая строка** с автокомплитом и историей последних запросов, сохраняемой в localStorage. Поиск происходит по названию трека, исполнителю, альбому и даже тексту песни при наличии.

**Фильтрация результатов** по категориям:
- Треки - основные результаты с возможностью мгновенного воспроизведения  
- Плейлисты - пользовательские и публичные коллекции
- Исполнители - переход к странице артиста со всеми треками
- Альбомы - группировка треков по релизам

**Результаты поиска** отображаются в виде единого списка с цветовой кодировкой по типам. Каждый результат содержит контекстные действия: воспроизвести, добавить в плейлист, добавить в очередь, лайкнуть.

**Расширенный поиск** через модальное окно позволяет задать дополнительные параметры: жанр, год выпуска, длительность трека, битрейт.

Поиск использует RTK Query с кэшированием частых запросов и предзагрузкой популярных результатов для мгновенного отображения.

### Структура страницы загрузки треков

Страница загрузки (`src/pages/upload-track/`) предназначена для добавления собственной музыки в систему:

**Drag & Drop зона** для перетаскивания аудио файлов с поддержкой множественной загрузки. Принимаются форматы MP3, FLAC, WAV, M4A с автоматической проверкой размера и качества.

**Форма метаданных** для каждого загружаемого файла:
- Название трека и исполнитель (автоматически извлекается из ID3 тегов)
- Жанр и год выпуска  
- Загрузка обложки или автоматическое извлечение из файла
- Описание и дополнительные теги

**Прогресс загрузки** с real-time индикаторами для каждого файла и общим прогрессом batch операции. При ошибках отображаются конкретные проблемы с возможностью повторной попытки.

**Batch обработка** позволяет применить одинаковые метаданные (исполнитель, жанр, год) к группе файлов, что ускоряет загрузку альбомов.

После успешной загрузки треки автоматически становятся доступными в библиотеке пользователя и могут быть добавлены в плейлисты или воспроизведены.
